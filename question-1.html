<!DOCTYPE html>
<html lang="en">
<head>
    <title>A small introduction to three.js webgl [1]</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/basic.css">

    <script src="three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/Detector.js"></script>
    <script type="text/javascript">
        let tree = THREE;
        // Checks that your browser supports WebGL.
        if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
        let curTime    = Date.now();
        let renderer = null;
        let scene = null;
        let camera = null;
        let systemeSolaire = null;
        let systemeTerre = null;
        let soleil = null;
        let terre = null;
        let lune = null;
        let cameraAngle = null;
        let orbiteTerre = null;
        let orbiteLune = null;
        let controls = null;
        function textureMat(path) {
            return new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load( path ) });
        }

        function colorMat(color) {
            return new THREE.MeshBasicMaterial({color: new tree.Color(color)});
        }

        function createTerre() {
            let terreMaterial = textureMat("images/earth_atmos_2048.jpg");
            terreMaterial.specular = new tree.Color(1,1,1);
            let terreGeometry = new THREE.SphereGeometry(1/3);
            return new THREE.Mesh(terreGeometry, terreMaterial);
        }

        function createSoleil() {
            let soleilMaterial = colorMat(0xffff00);
            let soleilGeometry = new THREE.SphereGeometry(1);
            return new THREE.Mesh(soleilGeometry, soleilMaterial);
        }

        function createLune() {
            let luneMaterial = textureMat("images/moon_1024.jpg");
            // luneMaterial.specular = new tree.Color(1,1,1);
            let luneGeometry = new THREE.SphereGeometry(.25);
            return new THREE.Mesh(luneGeometry, luneMaterial);
        }

        // This function is called whenever the document is loaded
        function init() {
            // Get display canvas
            let canvas = document.getElementById("webglcanvas");
            console.log( canvas );

            // Create the Three.js renderer and attach it to our canvas
            renderer = new THREE.WebGLRenderer( { canvas: canvas,
                antialias: true } );
            // Set the viewport size
            renderer.setSize( canvas.width, canvas.height );
            // Create a new Three.js scene
            scene = new THREE.Scene();
            // Add    a camera so we can view the scene
            camera = new THREE.PerspectiveCamera( 45, canvas.width / canvas.height,
                1, 4000 );

            let light = new THREE.PointLight( 0xffffff, 1.5);

            systemeSolaire = new tree.Group();
            orbiteTerre = new tree.Group();
            systemeTerre = new tree.Group();
            orbiteLune = new tree.Group();
            terre = createTerre();
            soleil= createSoleil();
            lune = createLune();
            soleil.position.set(0,0,0);
            systemeTerre.position.set(2*Math.sqrt(2), 0, 0);
            lune.position.set(1.5, 0, 0);
            systemeSolaire.add(orbiteTerre);
            systemeSolaire.add(light);
            systemeSolaire.add(soleil);
            orbiteTerre.add(systemeTerre);
            systemeTerre.add(terre);
            systemeTerre.add(orbiteLune);
            orbiteLune.add(lune);

            // Finally, add the mesh to our scene
            scene.add( systemeSolaire );
            camera.position.z -= 5;

            controls = new THREE.OrbitControls( camera, renderer.domElement );
//controls.addEventListener( 'change', render ); // call this only in static scenes (i.e., if there is no animation loop)
            controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.minDistance = 1;
            controls.maxDistance = 20;

        }

        // This function is called regularly to update the canvas webgl.
        function run() {
            // Ask to call again run
            requestAnimationFrame( run );

            // Render the scene
            render();

            // Calls the animate function if objects or camera should move
            animate();
        }

        // This function is called regularly to take care of the rendering.
        function render() {
            // Render the scene
            renderer.render( scene, camera );
        }

        // This function is called regularly to update objects.
        function animate() {
            let now = Date.now();
            let deltaTime = now - curTime;
            curTime       = now;
            let fracTime  = deltaTime / 20;
            let angle = fracTime * Math.PI * 2;
            cameraAngle       = fracTime * Math.PI * 2 ;
            orbiteTerre.rotation.y += angle / 365; // la terre tourne en 365 jours
            terre.rotation.y      += angle; // et en un jour sur elle-même
            orbiteLune.rotation.y  += angle / 28; // la lune tourne en 28 jours autour de la terre
            lune.rotation.y       += angle /28; // et en 28 jours aussi sur elle-même pour faire face à la terre
            camera.lookAt( terre.matrixWorld.getPosition() );
            // camera.position.x = 5 * Math.cos( cameraAngle );
            // camera.position.y = 3 * Math.sin( cameraAngle );
            controls.update();
        }

    </script>
</head>
<body>
<div id="info"> a first three.js example </div>
<canvas id="webglcanvas" style="border: none;background-color:#000000"
        width="600" height="500"></canvas>
<!-- We run the WebGL code at the end to be sure that the document is loaded.
    -->
<script>
    init(); run();
</script>
</body>
</html>

